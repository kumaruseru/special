<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Messaging System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">üí¨ Test Messaging System</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Connection Status -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">Connection Status</h2>
                <div id="connection-status" class="space-y-2">
                    <p class="text-gray-400">Connecting...</p>
                </div>
                <button onclick="connect()" class="mt-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded mr-2">
                    Connect
                </button>
                <button onclick="disconnect()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">
                    Disconnect
                </button>
            </div>

            <!-- Authentication -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">Authentication</h2>
                <input id="token-input" type="text" placeholder="Enter JWT Token" 
                       class="w-full bg-gray-700 px-3 py-2 rounded mb-4 text-white text-sm">
                <button onclick="authenticate()" class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded mb-2">
                    Authenticate
                </button>
                <button onclick="joinChat()" class="w-full bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded">
                    Join Chat (Guest)
                </button>
            </div>

            <!-- Send Message -->
            <div class="bg-gray-800 p-6 rounded-lg md:col-span-2">
                <h2 class="text-xl font-semibold mb-4">Send Message</h2>
                <div class="flex gap-2 mb-4">
                    <input id="message-input" type="text" placeholder="Type your message..." 
                           class="flex-1 bg-gray-700 px-3 py-2 rounded text-white">
                    <button onclick="sendMessage()" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded">
                        Send
                    </button>
                </div>
            </div>

            <!-- Messages -->
            <div class="bg-gray-800 p-6 rounded-lg md:col-span-2">
                <h2 class="text-xl font-semibold mb-4">Messages</h2>
                <div id="messages-container" class="space-y-2 max-h-64 overflow-y-auto bg-black p-4 rounded">
                    <p class="text-gray-400">No messages yet...</p>
                </div>
                <button onclick="clearMessages()" class="mt-4 bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                    Clear Messages
                </button>
            </div>

            <!-- Console Log -->
            <div class="bg-gray-800 p-6 rounded-lg md:col-span-2">
                <h2 class="text-xl font-semibold mb-4">Console Log</h2>
                <div id="console-log" class="bg-black p-4 rounded font-mono text-sm h-48 overflow-y-auto">
                    <p class="text-green-400">Console ready...</p>
                </div>
                <button onclick="clearConsole()" class="mt-4 bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                    Clear Console
                </button>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let isConnected = false;
        let isAuthenticated = false;
        let userId = null;
        let username = null;

        // Logging function
        function log(message, type = 'info') {
            const consoleLog = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-400' : 
                              type === 'success' ? 'text-green-400' : 
                              type === 'warning' ? 'text-yellow-400' : 'text-white';
            
            const logEntry = document.createElement('p');
            logEntry.className = colorClass;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            consoleLog.appendChild(logEntry);
            consoleLog.scrollTop = consoleLog.scrollHeight;
            console.log(`[Messaging Test] ${message}`);
        }

        // Clear console
        function clearConsole() {
            document.getElementById('console-log').innerHTML = '<p class="text-green-400">Console cleared...</p>';
        }

        // Clear messages
        function clearMessages() {
            document.getElementById('messages-container').innerHTML = '<p class="text-gray-400">No messages yet...</p>';
        }

        // Update connection status
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = `
                <p><span class="font-semibold">Connected:</span> 
                   <span class="${isConnected ? 'text-green-400' : 'text-red-400'}">
                       ${isConnected ? '‚úÖ Yes' : '‚ùå No'}
                   </span>
                </p>
                <p><span class="font-semibold">Authenticated:</span> 
                   <span class="${isAuthenticated ? 'text-green-400' : 'text-red-400'}">
                       ${isAuthenticated ? '‚úÖ Yes' : '‚ùå No'}
                   </span>
                </p>
                <p><span class="font-semibold">User ID:</span> ${userId || 'N/A'}</p>
                <p><span class="font-semibold">Username:</span> ${username || 'N/A'}</p>
            `;
        }

        // Connect to server
        function connect() {
            if (socket) {
                log('Disconnecting existing socket...', 'warning');
                socket.disconnect();
            }

            log('Connecting to server...');
            socket = io('https://special-n8pm.onrender.com', {
                transports: ['websocket', 'polling'],
                timeout: 20000
            });

            socket.on('connect', () => {
                isConnected = true;
                log('‚úÖ Connected to server', 'success');
                updateConnectionStatus();
            });

            socket.on('disconnect', (reason) => {
                isConnected = false;
                isAuthenticated = false;
                log(`‚ùå Disconnected: ${reason}`, 'error');
                updateConnectionStatus();
            });

            socket.on('authenticated', (data) => {
                isAuthenticated = true;
                userId = data.userId;
                username = data.username;
                log(`‚úÖ Authenticated as: ${username}`, 'success');
                updateConnectionStatus();
            });

            socket.on('authentication_failed', (data) => {
                isAuthenticated = false;
                log(`‚ùå Authentication failed: ${data.error}`, 'error');
                updateConnectionStatus();
            });

            socket.on('join_success', (data) => {
                log(`‚úÖ Joined chat: ${data.message}`, 'success');
            });

            socket.on('message_sent', (data) => {
                log(`üì§ Message sent: ${data.messageId}`, 'success');
            });

            socket.on('message_error', (data) => {
                log(`‚ùå Message error: ${data.error}`, 'error');
            });

            socket.on('new_message', (message) => {
                log(`üì® New message from ${message.senderName}: ${message.text}`);
                displayMessage(message, false);
            });
        }

        // Disconnect from server
        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                isConnected = false;
                isAuthenticated = false;
                userId = null;
                username = null;
                log('Disconnected from server', 'warning');
                updateConnectionStatus();
            }
        }

        // Authenticate with token
        function authenticate() {
            const token = document.getElementById('token-input').value.trim();
            
            if (!token) {
                log('‚ùå Please enter a token', 'error');
                return;
            }

            if (!socket || !isConnected) {
                log('‚ùå Not connected to server', 'error');
                return;
            }

            log('üîê Authenticating...');
            socket.emit('authenticate', { token: token });
        }

        // Join chat as guest
        function joinChat() {
            if (!socket || !isConnected) {
                log('‚ùå Not connected to server', 'error');
                return;
            }

            const guestName = 'TestUser_' + Math.random().toString(36).substr(2, 5);
            log(`üëã Joining chat as guest: ${guestName}`);
            
            socket.emit('join_chat', {
                userId: 'guest_' + Date.now(),
                username: guestName,
                avatar: `https://placehold.co/40x40/22C55E/FFFFFF?text=${guestName[0]}`
            });
            
            username = guestName;
            updateConnectionStatus();
        }

        // Send message
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();
            
            if (!messageText) {
                log('‚ùå Please enter a message', 'error');
                return;
            }

            if (!socket || !isConnected) {
                log('‚ùå Not connected to server', 'error');
                return;
            }

            const messageId = 'test_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            log(`üì§ Sending message: ${messageText}`);
            
            // Display message immediately
            const message = {
                id: messageId,
                text: messageText,
                senderName: username || 'You',
                timestamp: Date.now()
            };
            displayMessage(message, true);
            
            // Send to server
            socket.emit('send_message', {
                messageId: messageId,
                text: messageText,
                timestamp: Date.now(),
                chatId: 'global_chat'
            }, (acknowledgment) => {
                log(`üì® Send acknowledgment: ${JSON.stringify(acknowledgment)}`);
                
                if (acknowledgment && acknowledgment.success) {
                    log('‚úÖ Message confirmed sent', 'success');
                } else if (acknowledgment && acknowledgment.error) {
                    log(`‚ùå Send failed: ${acknowledgment.error}`, 'error');
                } else {
                    log('‚ö†Ô∏è No acknowledgment received', 'warning');
                }
            });

            messageInput.value = '';
        }

        // Display message in UI
        function displayMessage(message, isSent) {
            const container = document.getElementById('messages-container');
            
            if (container.firstChild && container.firstChild.textContent === 'No messages yet...') {
                container.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `p-3 rounded ${isSent ? 'bg-blue-900 ml-8' : 'bg-gray-700 mr-8'}`;
            
            const time = new Date(message.timestamp).toLocaleTimeString();
            messageDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-semibold text-sm">${message.senderName}</p>
                        <p class="mt-1">${message.text}</p>
                    </div>
                    <span class="text-xs text-gray-400 ml-2">${time}</span>
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Auto-connect and setup
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Messaging test page loaded');
            
            // Auto-fill token if available in localStorage
            const token = localStorage.getItem('authToken') || localStorage.getItem('token');
            if (token) {
                document.getElementById('token-input').value = token;
                log('üìã Found existing token in localStorage');
            }
            
            updateConnectionStatus();
            connect();
            
            // Enter key to send message
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>
