<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production API Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">üöÄ Production API Test</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Health Check -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">Health Check</h2>
                <button onclick="testHealth()" class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded mb-4">
                    Test Health Endpoint
                </button>
                <div id="health-result" class="bg-black p-4 rounded font-mono text-sm">
                    <p class="text-gray-400">Click button to test</p>
                </div>
            </div>

            <!-- Users API -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">Users API</h2>
                <button onclick="testUsers()" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded mb-4">
                    Test Users Endpoint
                </button>
                <div id="users-result" class="bg-black p-4 rounded font-mono text-sm">
                    <p class="text-gray-400">Click button to test</p>
                </div>
            </div>

            <!-- Token Refresh -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">Token Refresh</h2>
                <input id="email-input" type="email" placeholder="Enter email" 
                       class="w-full bg-gray-700 px-3 py-2 rounded mb-4 text-white">
                <button onclick="testRefresh()" class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded mb-4">
                    Test Refresh Token
                </button>
                <div id="refresh-result" class="bg-black p-4 rounded font-mono text-sm">
                    <p class="text-gray-400">Enter email and click button</p>
                </div>
            </div>

            <!-- TelegramAuth Test -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">TelegramAuth Integration</h2>
                <button onclick="testTelegramAuth()" class="w-full bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded mb-4">
                    Test with TelegramAuth
                </button>
                <div id="telegram-result" class="bg-black p-4 rounded font-mono text-sm">
                    <p class="text-gray-400">Click button to test</p>
                </div>
            </div>
        </div>

        <!-- Console Output -->
        <div class="bg-gray-800 p-6 rounded-lg mt-8">
            <h2 class="text-xl font-semibold mb-4">Console Output</h2>
            <div id="console-output" class="bg-black p-4 rounded font-mono text-sm h-64 overflow-y-auto">
                <p class="text-green-400">Console ready...</p>
            </div>
            <button onclick="clearConsole()" class="mt-4 bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                Clear Console
            </button>
        </div>
    </div>

    <!-- Include TelegramAuth if available -->
    <script src="assets/js/telegram-auth.js"></script>

    <script>
        const PRODUCTION_URL = 'https://special-n8pm.onrender.com';

        // Logging function
        function log(message, type = 'info') {
            const consoleOutput = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-400' : 
                              type === 'success' ? 'text-green-400' : 
                              type === 'warning' ? 'text-yellow-400' : 'text-white';
            
            const logEntry = document.createElement('p');
            logEntry.className = colorClass;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            console.log(`[Production Test] ${message}`);
        }

        // Clear console
        function clearConsole() {
            document.getElementById('console-output').innerHTML = '<p class="text-green-400">Console cleared...</p>';
        }

        // Test health endpoint
        async function testHealth() {
            const resultDiv = document.getElementById('health-result');
            log('üè• Testing health endpoint...');
            
            try {
                const response = await fetch(`${PRODUCTION_URL}/health`);
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <p class="text-green-400">‚úÖ Status: ${data.status}</p>
                    <p class="text-blue-400">üìä Database: ${data.database}</p>
                    <p class="text-yellow-400">‚è∞ Uptime: ${Math.round(data.uptime)}s</p>
                    <p class="text-purple-400">üåê Environment: ${data.environment}</p>
                `;
                
                log(`‚úÖ Health check successful: ${data.status}`, 'success');
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-400">‚ùå Error: ${error.message}</p>`;
                log(`‚ùå Health check failed: ${error.message}`, 'error');
            }
        }

        // Test users endpoint
        async function testUsers() {
            const resultDiv = document.getElementById('users-result');
            log('üë• Testing users endpoint...');
            
            try {
                const response = await fetch(`${PRODUCTION_URL}/api/users?limit=3`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <p class="text-green-400">‚úÖ Success: ${data.users.length} users</p>
                        <div class="mt-2 space-y-1">
                            ${data.users.map(user => 
                                `<p class="text-blue-400">üë§ ${user.name} (${user.email})</p>`
                            ).join('')}
                        </div>
                    `;
                    log(`‚úÖ Users API successful: ${data.users.length} users`, 'success');
                } else {
                    resultDiv.innerHTML = `<p class="text-yellow-400">‚ö†Ô∏è ${data.message}</p>`;
                    log(`‚ö†Ô∏è Users API: ${data.message}`, 'warning');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-400">‚ùå Error: ${error.message}</p>`;
                log(`‚ùå Users API failed: ${error.message}`, 'error');
            }
        }

        // Test refresh token
        async function testRefresh() {
            const resultDiv = document.getElementById('refresh-result');
            const email = document.getElementById('email-input').value;
            
            if (!email) {
                resultDiv.innerHTML = '<p class="text-red-400">‚ùå Please enter an email</p>';
                return;
            }
            
            log(`üîÑ Testing token refresh for: ${email}`);
            
            try {
                const response = await fetch(`${PRODUCTION_URL}/api/refresh-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <p class="text-green-400">‚úÖ Token refreshed!</p>
                        <p class="text-blue-400">üë§ User: ${data.user.name}</p>
                        <p class="text-yellow-400">üìß Email: ${data.user.email}</p>
                        <p class="text-purple-400">üîë Token: ${data.token.slice(0, 20)}...</p>
                    `;
                    log(`‚úÖ Token refresh successful for: ${data.user.name}`, 'success');
                    
                    // Store token for further tests
                    localStorage.setItem('testToken', data.token);
                    localStorage.setItem('testUser', JSON.stringify(data.user));
                } else {
                    resultDiv.innerHTML = `<p class="text-red-400">‚ùå ${data.message}</p>`;
                    log(`‚ùå Token refresh failed: ${data.message}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-400">‚ùå Error: ${error.message}</p>`;
                log(`‚ùå Token refresh error: ${error.message}`, 'error');
            }
        }

        // Test with TelegramAuth
        async function testTelegramAuth() {
            const resultDiv = document.getElementById('telegram-result');
            
            if (typeof TelegramAuth === 'undefined') {
                resultDiv.innerHTML = '<p class="text-red-400">‚ùå TelegramAuth not loaded</p>';
                log('‚ùå TelegramAuth class not available', 'error');
                return;
            }
            
            log('üîê Testing TelegramAuth integration...');
            
            try {
                const telegramAuth = new TelegramAuth({
                    baseUrl: PRODUCTION_URL
                });
                
                const authState = telegramAuth.getAuthState();
                
                resultDiv.innerHTML = `
                    <p class="text-blue-400">üîê TelegramAuth loaded</p>
                    <p class="text-${authState.isAuthenticated ? 'green' : 'red'}-400">
                        ${authState.isAuthenticated ? '‚úÖ' : '‚ùå'} Authenticated: ${authState.isAuthenticated}
                    </p>
                    <p class="text-yellow-400">üë§ User: ${authState.username || 'N/A'}</p>
                    <p class="text-purple-400">üìß Email: ${authState.email || 'N/A'}</p>
                `;
                
                log(`üîê TelegramAuth state: ${authState.isAuthenticated ? 'Authenticated' : 'Not authenticated'}`, 'info');
                
                // Try to make an authenticated request
                if (authState.isAuthenticated) {
                    log('üì° Testing authenticated request...');
                    const response = await telegramAuth.makeAuthenticatedRequest('/api/users?limit=2');
                    const data = await response.json();
                    log(`üìä Authenticated request result: ${data.success ? 'Success' : 'Failed'}`, data.success ? 'success' : 'warning');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-400">‚ùå Error: ${error.message}</p>`;
                log(`‚ùå TelegramAuth test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run health check on load
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Production API Test loaded');
            testHealth();
        });
    </script>
</body>
</html>
