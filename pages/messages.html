<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Social App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #090a0f;
            color: #E5E7EB; /* gray-200 */
        }
        #cosmic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -10;
        }
        .glass-pane {
            background: rgba(10, 10, 20, 0.5);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(0, 191, 255, 0.2);
            animation: float 8s ease-in-out infinite;
        }
        main .glass-pane {
             animation-delay: -2s;
        }
        .main-button {
            background: linear-gradient(45deg, #4F46E5, #00BFFF);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 191, 255, 0.2);
        }
        .main-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }
        .logout-button {
            background-color: rgba(220, 38, 38, 0.2);
            border: 1px solid rgba(220, 38, 38, 0.4);
            transition: all 0.3s ease;
        }
        .logout-button:hover {
            background-color: rgba(220, 38, 38, 0.4);
            color: #fecaca;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }
        /* Custom Scrollbars */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(0, 191, 255, 0.3);
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(0, 191, 255, 0.5); }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 3D Cosmic Background -->
    <canvas id="cosmic-bg" class="fixed inset-0 -z-10"></canvas>
    
    <!-- Main Layout -->
    <div class="min-h-screen">
        <!-- Navigation -->
        <nav id="main-nav" class="glass-pane fixed top-4 left-1/2 transform -translate-x-1/2 z-50 rounded-full px-6 py-3">
            <div class="flex space-x-6">
                <a href="home.html" class="nav-link px-4 py-2 rounded-lg transition-all duration-300 hover:bg-gray-800/50 text-gray-300">
                    <i class="fas fa-home mr-2"></i>Home
                </a>
                <a href="discovery.html" class="nav-link px-4 py-2 rounded-lg transition-all duration-300 hover:bg-gray-800/50 text-gray-300">
                    <i class="fas fa-compass mr-2"></i>Discovery
                </a>
                <a href="messages.html" class="nav-link px-4 py-2 rounded-lg transition-all duration-300 text-white bg-gray-500/20">
                    <i class="fas fa-envelope mr-2"></i>Messages
                </a>
                <a href="profile.html" class="nav-link px-4 py-2 rounded-lg transition-all duration-300 hover:bg-gray-800/50 text-gray-300">
                    <i class="fas fa-user mr-2"></i>Profile
                </a>
                <a href="settings.html" class="nav-link px-4 py-2 rounded-lg transition-all duration-300 hover:bg-gray-800/50 text-gray-300">
                    <i class="fas fa-cog mr-2"></i>Settings
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="glass-pane mx-4 mt-24 mb-8 rounded-3xl min-h-[calc(100vh-8rem)] p-6">
            <!-- Messages Page -->
            <div id="page-messages" class="page-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                    <!-- Conversations List -->
                    <div class="lg:col-span-1 bg-gray-800/30 rounded-2xl p-4 custom-scroll overflow-y-auto max-h-[calc(100vh-12rem)]">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-white">Conversations</h2>
                            <button class="text-blue-400 hover:text-blue-300 transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        
                        <!-- Search Bar -->
                        <div class="relative mb-4">
                            <input type="text" id="searchInput" placeholder="Search conversations..." 
                                   class="w-full bg-gray-700/50 border border-gray-600/50 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-400 transition-colors">
                            <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>

                        <!-- Conversations -->
                        <div id="conversationsList" class="space-y-2">
                            <div class="loading-conversations text-center py-8">
                                <i class="fas fa-spinner fa-spin text-blue-400 text-2xl mb-2"></i>
                                <p class="text-gray-400">Loading conversations...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div class="lg:col-span-2 bg-gray-800/30 rounded-2xl p-4 flex flex-col">
                        <!-- Chat Header -->
                        <div class="flex items-center justify-between pb-4 border-b border-gray-600/30 mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                <div>
                                    <h3 id="currentChatName" class="text-white font-semibold">Select a conversation</h3>
                                    <p id="currentChatStatus" class="text-sm text-gray-400">Click a conversation to start chatting</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button class="p-2 text-gray-400 hover:text-white transition-colors rounded-lg hover:bg-gray-700/50">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="p-2 text-gray-400 hover:text-white transition-colors rounded-lg hover:bg-gray-700/50">
                                    <i class="fas fa-phone"></i>
                                </button>
                                <button class="p-2 text-gray-400 hover:text-white transition-colors rounded-lg hover:bg-gray-700/50">
                                    <i class="fas fa-video"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Messages Area -->
                        <div id="messagesList" class="flex-1 custom-scroll overflow-y-auto space-y-4 mb-4">
                            <div class="empty-state text-center py-12">
                                <div class="w-16 h-16 bg-gray-700/50 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-comments text-gray-400 text-2xl"></i>
                                </div>
                                <h3 class="text-white text-lg font-semibold mb-2">Welcome to Messages!</h3>
                                <p class="text-gray-400">Select a conversation to start chatting</p>
                            </div>
                        </div>

                        <!-- Message Input -->
                        <div class="flex items-end space-x-3">
                            <button class="p-3 text-gray-400 hover:text-white transition-colors rounded-lg hover:bg-gray-700/50">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <div class="flex-1 relative">
                                <textarea id="messageInput" placeholder="Type a message..." rows="1"
                                         class="w-full bg-gray-700/50 border border-gray-600/50 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:border-blue-400 transition-colors resize-none max-h-32"></textarea>
                            </div>
                            <button id="sendButton" class="main-button p-3 rounded-lg text-white transition-all">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>

                        <!-- Typing Indicator -->
                        <div id="typingIndicator" class="hidden mt-2 flex items-center space-x-2 text-gray-400 text-sm">
                            <div class="flex space-x-1">
                                <div class="w-1 h-1 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-1 h-1 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-1 h-1 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                            <span class="typing-text">Someone is typing...</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="../assets/js/messages.js"></script>

    <script>
        // Global variables for messaging
        let socket;
        let currentUser = null;
        let currentConversation = null;
        let conversations = [];
        let messages = [];

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initializeAuth();
            initializeSocket();
            initializeUI();
            initializeBackground();
        });

        // Authentication check
        function initializeAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            // Decode token to get user info
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUser = { id: payload.userId, username: payload.username };
                console.log('Current user:', currentUser);
            } catch (error) {
                console.error('Invalid token:', error);
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        }

        // Socket.IO initialization
        function initializeSocket() {
            const token = localStorage.getItem('token');
            socket = io('/', {
                auth: { token: token }
            });

            socket.on('connect', () => {
                console.log('Connected to server');
                loadConversations();
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
            });

            socket.on('newMessage', (message) => {
                handleNewMessage(message);
            });

            socket.on('typing', (data) => {
                handleTyping(data);
            });

            socket.on('stopTyping', (data) => {
                handleStopTyping(data);
            });
        }

        // UI initialization
        function initializeUI() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const searchInput = document.getElementById('searchInput');

            // Auto-resize textarea
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = messageInput.scrollHeight + 'px';
            });

            // Send message on Enter
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Send button click
            sendButton.addEventListener('click', sendMessage);

            // Search conversations
            searchInput.addEventListener('input', (e) => {
                filterConversations(e.target.value);
            });
        }

        // Load conversations
        async function loadConversations() {
            try {
                const response = await fetch('/api/conversations', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    conversations = await response.json();
                    renderConversations();
                } else {
                    console.error('Failed to load conversations');
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        // Render conversations list
        function renderConversations() {
            const conversationsList = document.getElementById('conversationsList');
            
            if (conversations.length === 0) {
                conversationsList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-12 h-12 bg-gray-700/50 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-comments text-gray-400"></i>
                        </div>
                        <p class="text-gray-400">No conversations yet</p>
                        <p class="text-gray-500 text-sm">Start a new chat to begin!</p>
                    </div>
                `;
                return;
            }

            conversationsList.innerHTML = conversations.map(conv => `
                <div class="conversation-item p-3 rounded-lg cursor-pointer transition-colors hover:bg-gray-700/30 ${conv.id === currentConversation?.id ? 'bg-blue-600/20 border-l-2 border-blue-400' : ''}" 
                     onclick="selectConversation('${conv.id}')">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-sm font-semibold text-white">
                            ${conv.name ? conv.name.charAt(0).toUpperCase() : 'U'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <h4 class="text-white font-medium truncate">${conv.name || 'Unknown User'}</h4>
                                <span class="text-xs text-gray-400">${formatTime(conv.lastMessage?.createdAt)}</span>
                            </div>
                            <p class="text-gray-400 text-sm truncate">${conv.lastMessage?.content || 'No messages yet'}</p>
                        </div>
                        ${conv.unreadCount > 0 ? `<div class="w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center text-xs text-white">${conv.unreadCount}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Select conversation
        async function selectConversation(conversationId) {
            try {
                const conversation = conversations.find(c => c.id === conversationId);
                if (!conversation) return;

                currentConversation = conversation;
                
                // Update chat header
                document.getElementById('currentChatName').textContent = conversation.name || 'Unknown User';
                document.getElementById('currentChatStatus').textContent = 'Online';

                // Load messages
                await loadMessages(conversationId);
                
                // Re-render conversations to update selection
                renderConversations();

                // Join conversation room
                socket.emit('joinConversation', conversationId);

            } catch (error) {
                console.error('Error selecting conversation:', error);
            }
        }

        // Load messages for conversation
        async function loadMessages(conversationId) {
            try {
                const response = await fetch(`/api/conversations/${conversationId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    messages = await response.json();
                    renderMessages();
                } else {
                    console.error('Failed to load messages');
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Render messages
        function renderMessages() {
            const messagesList = document.getElementById('messagesList');
            
            if (messages.length === 0) {
                messagesList.innerHTML = `
                    <div class="empty-state text-center py-12">
                        <div class="w-16 h-16 bg-gray-700/50 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-comments text-gray-400 text-2xl"></i>
                        </div>
                        <h3 class="text-white text-lg font-semibold mb-2">Start the conversation!</h3>
                        <p class="text-gray-400">Send the first message to get things started.</p>
                    </div>
                `;
                return;
            }

            messagesList.innerHTML = messages.map(message => {
                const isOwn = message.senderId === currentUser.id;
                return `
                    <div class="flex ${isOwn ? 'justify-end' : 'justify-start'} mb-4">
                        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isOwn ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-100'}">
                            ${!isOwn ? `<div class="text-xs text-gray-400 mb-1">${message.senderName || 'Unknown'}</div>` : ''}
                            <div class="text-sm">${escapeHtml(message.content)}</div>
                            <div class="text-xs mt-1 ${isOwn ? 'text-blue-200' : 'text-gray-400'}">${formatTime(message.createdAt)}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            messagesList.scrollTop = messagesList.scrollHeight;
        }

        // Send message
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();

            if (!content || !currentConversation) return;

            try {
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        conversationId: currentConversation.id,
                        content: content
                    })
                });

                if (response.ok) {
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    
                    // Emit to socket for real-time delivery
                    socket.emit('sendMessage', {
                        conversationId: currentConversation.id,
                        content: content
                    });
                } else {
                    console.error('Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Handle new message from socket
        function handleNewMessage(message) {
            if (currentConversation && message.conversationId === currentConversation.id) {
                messages.push(message);
                renderMessages();
            }
            
            // Update conversation list
            loadConversations();
        }

        // Handle typing indicators
        function handleTyping(data) {
            if (currentConversation && data.conversationId === currentConversation.id && data.userId !== currentUser.id) {
                const typingIndicator = document.getElementById('typingIndicator');
                const typingText = document.querySelector('.typing-text');
                typingText.textContent = `${data.username} is typing...`;
                typingIndicator.classList.remove('hidden');
            }
        }

        function handleStopTyping(data) {
            if (currentConversation && data.conversationId === currentConversation.id) {
                const typingIndicator = document.getElementById('typingIndicator');
                typingIndicator.classList.add('hidden');
            }
        }

        // Filter conversations
        function filterConversations(query) {
            const filteredConversations = conversations.filter(conv => 
                conv.name?.toLowerCase().includes(query.toLowerCase()) ||
                conv.lastMessage?.content?.toLowerCase().includes(query.toLowerCase())
            );
            
            const conversationsList = document.getElementById('conversationsList');
            if (filteredConversations.length === 0 && query) {
                conversationsList.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-search text-gray-400 text-2xl mb-2"></i>
                        <p class="text-gray-400">No conversations found</p>
                        <p class="text-gray-500 text-sm">Try a different search term</p>
                    </div>
                `;
            } else {
                conversations = query ? filteredConversations : conversations;
                renderConversations();
            }
        }

        // Utility functions
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diffInHours = (now - date) / (1000 * 60 * 60);
            
            if (diffInHours < 24) {
                return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('vi-VN', { month: 'short', day: 'numeric' });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 3D Cosmic Background
        function initializeBackground() {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.z = 1;
            const renderer = new THREE.WebGLRenderer({
                canvas: document.getElementById('cosmic-bg'),
                antialias: true,
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            const starGeo = new THREE.BufferGeometry();
            const starCount = 6000;
            const posArray = new Float32Array(starCount * 3);
            for (let i = 0; i < starCount * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 600;
            }
            starGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            
            const starMaterial = new THREE.PointsMaterial({
                size: 0.5,
                color: 0xaaaaaa,
                transparent: true,
            });
            
            const stars = new THREE.Points(starGeo, starMaterial);
            scene.add(stars);
            
            let mouseX = 0;
            let mouseY = 0;
            document.addEventListener('mousemove', (event) => {
                mouseX = event.clientX;
                mouseY = event.clientY;
            });
            
            const clock = new THREE.Clock();
            const animate = () => {
                requestAnimationFrame(animate);
                const elapsedTime = clock.getElapsedTime();
                stars.rotation.y = -mouseX * 0.00005;
                stars.rotation.x = -mouseY * 0.00005;
                camera.position.z = 1 + (document.documentElement.scrollTop || document.body.scrollTop) * 0.001;
                renderer.render(scene, camera);
            };
            animate();
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
    </script>
</body>
</html>
